{"version":3,"file":"sls.cjs.js","sources":["../src/config/bff.config.ts","../src/environment.ts","../src/server/helpers/configurer.ts","../src/server/renderer/template.ts","../src/server/renderer/prod.ts","../src/constants/error.ts","../src/constants/proxy.ts","../src/server/proxy.ts","../src/config/app.config.ts","../src/server/cache.ts","../src/server/index.ts","../src/sls.ts"],"sourcesContent":["/**\n * @file BFF server config\n * @module config.bff\n * @author Surmon <https://github.com/surmon-china>\n */\n\nexport const BFF_TUNNEL_PREFIX = '/_tunnel'\nexport const BFF_PROXY_PREFIX = '/_proxy'\nexport const BFF_PROXY_ALLOWLIST = ['https://surmon.me', 'https://cdn.surmon.me']\n\nexport const getBFFServerPort = () => Number(process.env.PORT || 3000)\n","/**\n * @file Dev environment\n * @module environment\n * @author Surmon <https://github.com/surmon-china>\n */\n\nexport enum NodeEnv {\n  Development = 'development',\n  Production = 'production',\n  Test = 'test'\n}\n\nexport const NODE_ENV = process.env.NODE_ENV as NodeEnv\nexport const isDev = process.env.NODE_ENV === NodeEnv.Development\nexport const isProd = process.env.NODE_ENV === NodeEnv.Production\nexport const isTest = process.env.NODE_ENV === NodeEnv.Test\n","/**\n * @file BFF Server helper\n * @module server.helper\n * @author Surmon <https://github.com/surmon-china>\n */\n\nimport path from 'path'\nimport { isDev } from '@/environment'\n\n// MARK: 与非生产资料解耦\nexport const NODEPRESS_API = `https://api.surmon.me`\n\nexport const ROOT_PATH = process.cwd()\nexport const DIST_PATH = path.join(ROOT_PATH, 'dist')\nexport const PRDO_CLIENT_PATH = path.join(DIST_PATH, 'client')\nexport const PRDO_SERVER_PATH = path.join(DIST_PATH, 'server')\n\nexport const PUBLIC_PATH = isDev ? path.join(ROOT_PATH, 'public') : PRDO_CLIENT_PATH\n","import type { MetaResult } from '@/composables/meta'\n\nexport const resolveTemplate = (config: {\n  template: string\n  appHTML: string\n  metas: MetaResult\n  scripts?: string\n  manifest?: any\n}) => {\n  const { template, appHTML, metas, scripts } = config\n\n  const bodyScripts = [\n    scripts\n    // MARK: https://cn.vitejs.dev/config/#build-ssrmanifest\n    // client output less assets (3 js + 1 css) & built-in HTML\n    // manifest\n  ].join('\\n')\n\n  const html = template\n    // MARK: replace! $ sign & use function replacer\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace#specifying_a_string_as_a_parameter\n    .replace(/<title>[\\s\\S]*<\\/title>/, '')\n    .replace(`<html`, () => `<html ${metas.htmlAttrs} `)\n    .replace(`<head>`, () => `<head>\\n${metas.headTags}`)\n    .replace(`<!--app-html-->`, () => appHTML)\n    .replace(`<body>`, () => `<body ${metas.bodyAttrs}>`)\n    .replace(`</body>`, () => `\\n${bodyScripts}\\n</body>`)\n\n  return html\n}\n","import fs from 'fs'\nimport path from 'path'\nimport { Express } from 'express'\nimport { DIST_PATH, PRDO_SERVER_PATH } from '../helpers/configurer'\nimport { CacheClient } from '../cache'\nimport { resolveTemplate } from './template'\nimport type { RenderResult } from '@/ssr'\n\nexport const enableProdRenderer = async (app: Express, cache: CacheClient) => {\n  const template = fs.readFileSync(path.resolve(DIST_PATH, 'template.html'), 'utf-8')\n  // eslint-disable-next-line @typescript-eslint/no-var-requires\n  const { renderApp, renderError } = require(path.resolve(PRDO_SERVER_PATH, 'ssr.js'))\n\n  app.use('*', async (request, response) => {\n    try {\n      const redered: RenderResult = await renderApp(request, cache)\n      response\n        .status(redered.code)\n        .set({ 'Content-Type': 'text/html' })\n        .end(\n          resolveTemplate({\n            template,\n            appHTML: redered.html,\n            metas: redered.metas,\n            scripts: redered.scripts\n          })\n        )\n    } catch (error: any) {\n      const redered: RenderResult = await renderError(request, error)\n      response.status(redered.code).end(\n        resolveTemplate({\n          template,\n          appHTML: redered.html,\n          metas: redered.metas,\n          scripts: redered.scripts\n        })\n      )\n    }\n  })\n}\n","/**\n * @file Error constant\n * @module constant.error\n * @author Surmon <https://github.com/surmon-china>\n */\n\nexport const BAD_REQUEST = 400\nexport const FORBIDDEN = 403\nexport const NOT_FOUND = 404\nexport const INVALID_ERROR = 500\n","/**\n * @file Proxy constant\n * @module constant.proxy\n * @author Surmon <https://github.com/surmon-china>\n */\n\nexport enum ProxyModule {\n  Default = 'default',\n  Instagram = 'instagram',\n  YouTube = 'youtube',\n  NetEasyMusic = '163',\n  Disqus = 'disqus'\n}\n","/**\n * @file BFF Server proxy\n * @module server.proxy\n * @author Surmon <https://github.com/surmon-china>\n */\n\nimport { RequestHandler } from 'express'\nimport { createProxyServer } from 'http-proxy'\nimport { FORBIDDEN, BAD_REQUEST } from '@/constants/error'\nimport { ProxyModule } from '@/constants/proxy'\nimport { BFF_PROXY_PREFIX, BFF_PROXY_ALLOWLIST } from '@/config/bff.config'\nimport { isProd } from '@/environment'\n\ninterface ProxyConfigItem {\n  module: ProxyModule\n  origin?: string\n  referer?: string\n}\n\nconst proxys: ProxyConfigItem[] = [\n  {\n    module: ProxyModule.Default,\n    origin: 'https://surmon.me',\n    referer: 'https://surmon.me/'\n  },\n  {\n    module: ProxyModule.Instagram,\n    origin: 'https://www.instagram.com',\n    referer: 'https://www.instagram.com/'\n  },\n  {\n    module: ProxyModule.YouTube,\n    origin: 'https://www.youtube.com',\n    referer: 'https://www.youtube.com/'\n  },\n  {\n    module: ProxyModule.NetEasyMusic,\n    origin: 'https://music.163.com',\n    referer: 'https://music.163.com/'\n  },\n  {\n    module: ProxyModule.Disqus,\n    referer: 'https://surmon.disqus.com/'\n  }\n]\n\nexport const PROXY_ROUTE_PATH = `${BFF_PROXY_PREFIX}/:module/*`\n\nexport const proxyer = (): RequestHandler => {\n  // https://github.com/http-party/node-http-proxy\n  const proxyMap = new Map(proxys.map(({ module, ...rest }) => [module, rest]))\n  const proxy = createProxyServer({\n    prependPath: true,\n    ignorePath: true,\n    toProxy: false,\n    xfwd: true\n  })\n\n  // https://github.com/http-party/node-http-proxy/issues/813\n  proxy.on('error', (error: any, _, response: any, target: any) => {\n    console.warn(`[BFF] proxy error: ${error.message} > ${target?.href}`)\n    if (!response.headersSent) {\n      response.writeHead(500, { 'content-type': 'application/json' })\n    }\n    response.end(JSON.stringify({ error: 'proxy_error', reason: error.message }))\n  })\n\n  proxy.on('proxyReq', (proxyRequest) => {\n    proxyRequest.setHeader(\n      'User-Agent',\n      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3223.8 Safari/'\n    )\n  })\n\n  proxy.on('proxyRes', (proxyResponse, request: any) => {\n    const statusCode = proxyResponse.statusCode as number\n    const location = proxyResponse.headers.location\n    if ([301, 302, 307, 308].includes(statusCode) && location) {\n      proxyResponse.headers.location = `${BFF_PROXY_PREFIX}/${\n        request.params.module\n      }/${encodeURIComponent(location)}`\n    }\n    // proxy cache\n    if (statusCode === 200) {\n      proxyResponse.headers['cache-control'] = `max-age=315360000`\n    }\n  })\n\n  return (request, response) => {\n    if (isProd) {\n      const referer = (request.headers.referrer as string) || request.headers.referer\n      const origin = request.headers.origin\n      const isAllowedReferer = !referer || BFF_PROXY_ALLOWLIST.some((i) => referer.startsWith(i))\n      const isAllowedOrigin = !origin || BFF_PROXY_ALLOWLIST.some((i) => origin.startsWith(i))\n      if (!isAllowedReferer || !isAllowedOrigin) {\n        response.status(FORBIDDEN).send()\n        return\n      }\n    }\n\n    const config = proxyMap.get(request.params.module as ProxyModule)\n    const targetURL = decodeURIComponent(request.params['0'])\n    let parsedURL: URL | null = null\n    try {\n      parsedURL = new URL(targetURL)\n    } catch (error) {\n      response.status(BAD_REQUEST).send()\n      return\n    }\n\n    const headers: any = {}\n    if (config?.origin) {\n      headers['Origin'] = config.origin\n    }\n    if (config?.referer) {\n      headers['Referer'] = config.referer\n    }\n\n    proxy.web(request, response, {\n      target: targetURL,\n      changeOrigin: true,\n      followRedirects: false,\n      autoRewrite: false,\n      headers: {\n        host: parsedURL.hostname,\n        ...headers\n      }\n    })\n  }\n}\n","/**\n * @file App config\n * @module config.app\n * @author Surmon <https://github.com/surmon-china>\n */\n\nexport const DEFAULT_DELAY = 468\nexport const LONG_ARTICLE_THRESHOLD = 16688\nexport const PRIMARY_COLOR = '#0088f5'\nexport const GA_MEASUREMENT_ID = 'UA-84887611-3'\nexport const ADSENSE_CLIENT_ID = 'ca-pub-4710915636313788'\n\nexport const META = Object.freeze({\n  title: 'Surmon.me',\n  zh_sub_title: '来苏之望',\n  en_sub_title: 'Because the mountain is there',\n  url: 'https://surmon.me',\n  domain: 'surmon.me',\n  author: 'Surmon'\n})\n\nexport const THIRD_IDS = Object.freeze({\n  YOUTUBE_CHANNEL_ID: `UCoL-j6T28PLSJ2U6ZdONS0w`,\n  MUSIC_163_BGM_ALBUM_ID: '638949385',\n  GITHUB_USER_ID: 'surmon-china',\n  TWITTER_USER_ID: 'surmon7788',\n  INSTAGRAM_USERNAME: 'surmon666',\n  INSTAGRAM_FB_ID: '17841405600281893'\n})\n\nexport const SPONSOR_LINKS = Object.freeze({\n  PAYPAL: 'https://paypal.me/surmon',\n  GITHUB_SPONSORS: 'https://github.com/sponsors/surmon-china',\n  BTC_ADDRESS: 'bc1qhpdu03tnexkj4xsm3lqzyjdddz6z0rj2n7fsze',\n  ETH_ADDRESS: '0xaD556974D449126efdeF23f4FF581861C301cB77'\n})\n\nexport const VALUABLE_LINKS = Object.freeze({\n  RSS: '/rss.xml',\n  SITE_MAP: '/sitemap.xml',\n\n  GITHUB_SURMON_ME: 'https://github.com/surmon-china/surmon.me',\n  GITHUB_NODEPRESS: 'https://github.com/surmon-china/nodepress',\n  GITHUB_SURMON_ME_NATIVE: 'https://github.com/surmon-china/surmon.me.native',\n  GITHUB_BLOG_STAR_LIST: 'https://github.com/stars/surmon-china/lists/surmon-me',\n  APP_APK_FILE:\n    'https://raw.githubusercontent.com/surmon-china/surmon.me.native/master/dist/android/surmon.me.apk',\n  GITHUB: 'https://github.com/surmon-china',\n  UPWORK: 'https://www.upwork.com/freelancers/~0142e621258ac1770d',\n  MARKDOWN: 'https://daringfireball.net/projects/markdown/',\n  GOOGLE_ROAD_MAP: 'https://www.google.com/maps/d/embed?mid=1sRx6t0Yj1TutbwORCvjwTMgr70r62Z6w&z=3',\n  DISCORD_GROUP: 'https://discord.gg/cXdGT7Gx86',\n  TELEGRAM_GROUP: 'https://t.me/joinchat/F6wOlxYwSCUpZTYj3WTAWA',\n  SPOTIFY: 'https://open.spotify.com/user/v0kz9hpwpbqnmtnrfhbyl812o',\n  MUSIC_163: `https://music.163.com/#/playlist?id=${THIRD_IDS.MUSIC_163_BGM_ALBUM_ID}`,\n  YOUTUBE_CHANNEL: `https://www.youtube.com/channel/${THIRD_IDS.YOUTUBE_CHANNEL_ID}`,\n  TELEGRAM: 'https://t.me/surmon',\n  DOUBAN: 'https://www.douban.com/people/nocower',\n  ZHIHU: 'https://www.zhihu.com/people/surmon',\n  QUORA: 'https://www.quora.com/profile/Surmon',\n  LINKEDIN: 'https://www.linkedin.com/in/surmon',\n  INSTAGRAM: `https://www.instagram.com/${THIRD_IDS.INSTAGRAM_USERNAME}`,\n  TWITTER: `https://twitter.com/${THIRD_IDS.TWITTER_USER_ID}`\n})\n","/**\n * @file Universal Server cache\n * @module server.cache\n * @author Surmon <https://github.com/surmon-china>\n */\n\nimport LRU from 'lru-cache'\nimport { createClient } from 'redis'\nimport { META } from '@/config/app.config'\n\nexport interface CacheClient {\n  set(\n    key: string,\n    value: any,\n    /** cache age [seconds] */\n    maxAge?: number\n  ): Promise<void>\n  get<T = any>(key: string): Promise<T>\n  has(key: string): Promise<boolean>\n  delete(key: string): Promise<any>\n  clear(): Promise<void>\n}\n\nconst getLRUClient = (): CacheClient => {\n  // https://github.com/isaacs/node-lru-cache\n  const lruCache = new LRU<string, any>({\n    max: 500,\n    ttl: 0 // MARK: default 0 \"no TTL\" never expire\n  })\n\n  return {\n    set: async (key: string, value: any, maxAge?: number) => {\n      if (maxAge) {\n        lruCache.set(key, value, { ttl: maxAge * 1000 })\n      } else {\n        lruCache.set(key, value)\n      }\n    },\n    get: async (key) => lruCache.get(key)!,\n    has: async (key) => lruCache.has(key),\n    delete: async (key) => lruCache.delete(key),\n    clear: async () => lruCache.clear()\n  }\n}\n\nconst getRedisClient = async (): Promise<CacheClient> => {\n  // https://github.com/redis/node-redis\n  const client = createClient({\n    socket: {\n      // Only once connect! Redis error > reject\n      reconnectStrategy: () => new Error(`can't connect to Redis!`)\n    }\n  })\n  client.on('connect', () => console.info('[redis]', 'connecting...'))\n  client.on('reconnecting', () => console.info('[redis]', 'reconnecting...'))\n  client.on('ready', () => console.info('[redis]', 'readied!'))\n  client.on('error', (error) => console.warn('[redis]', 'Client Error!', error.message || error))\n  await client.connect()\n\n  const getCacheKey = (key: string) => {\n    const cacheKeyPrefix = META.domain.replace(/\\./gi, '_')\n    return `__${cacheKeyPrefix}_${key}`\n  }\n\n  const set: CacheClient['set'] = async (key, value, maxAge) => {\n    const _value = value ? JSON.stringify(value) : ''\n    if (maxAge) {\n      // https://redis.io/commands/setex\n      await client.setEx(getCacheKey(key), maxAge, _value)\n    } else {\n      await client.set(getCacheKey(key), _value)\n    }\n  }\n\n  const get: CacheClient['get'] = async (key) => {\n    const value = await client.get(getCacheKey(key))\n    return value ? JSON.parse(value) : value\n  }\n\n  const has: CacheClient['has'] = async (key) => {\n    const value = await client.exists(getCacheKey(key))\n    return Boolean(value)\n  }\n\n  const del: CacheClient['delete'] = (key) => client.del(getCacheKey(key))\n\n  const clear: CacheClient['clear'] = async () => {\n    const keys = await client.keys(getCacheKey('*'))\n    if (keys.length) {\n      await client.del(keys)\n    }\n  }\n\n  return {\n    set,\n    get,\n    has,\n    delete: del,\n    clear\n  }\n}\n\nexport const initCacheClient = async () => {\n  let cacheClient: CacheClient | null = null\n  try {\n    cacheClient = await getRedisClient()\n    console.info('[cache]', 'Redis store readied!')\n  } catch (error) {\n    cacheClient = getLRUClient()\n    console.info('[cache]', 'LRU store readied!')\n  }\n  await cacheClient.clear()\n  return cacheClient\n}\n","/**\n * @file BFF Server main\n * @module server.index\n * @author Surmon <https://github.com/surmon-china>\n */\n\nimport http from 'http'\nimport express from 'express'\nimport compression from 'compression'\nimport cookieParser from 'cookie-parser'\nimport { PROXY_ROUTE_PATH, proxyer } from './proxy'\nimport { initCacheClient } from './cache'\n\nexport const createExpressApp = async () => {\n  // init cache client\n  const cache = await initCacheClient()\n\n  // init app\n  const app = express()\n  const server = http.createServer(app)\n\n  // app proxy\n  app.use(PROXY_ROUTE_PATH, proxyer())\n\n  // app middlewares\n  app.use(express.json())\n  app.use(cookieParser())\n  app.use(compression())\n\n  return {\n    app,\n    server,\n    cache\n  }\n}\n","/**\n * @file Serverless server entry\n * @module Serverless\n * @author Surmon <https://github.com/surmon-china>\n */\n\nimport { getBFFServerPort } from '@/config/bff.config'\nimport { enableProdRenderer } from './server/renderer/prod'\nimport { createExpressApp } from './server'\n\nlet slsServer: Awaited<ReturnType<typeof createExpressApp>> | null = null\n\n// TODO\nexport const initializer = async (context, callback) => {\n  console.log('serverless initializing')\n  slsServer = await createExpressApp()\n  enableProdRenderer(slsServer.app, slsServer.cache)\n  slsServer.server.listen(getBFFServerPort())\n  callback(null, '')\n}\n\n// MARK\nexport const handler = (request, response) => {\n  // slsServer?.app\n  // ...\n  console.log('hello world')\n  response.send('hello world')\n}\n"],"names":["path","fs","createProxyServer","LRU","createClient","express","http","cookieParser","compression"],"mappings":"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"}